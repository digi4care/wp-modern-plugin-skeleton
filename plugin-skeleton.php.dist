<?php
/**
 * Plugin Name:       WP Modern Plugin Skeleton
 * Plugin URI:        https://github.com/digi4care/wp-modern-plugin-skeleton
 * Description:       Modern WordPress plugin skeleton using hexagonal architecture with example functionality
 * Version:           1.0.0
 * Author:            Your Name
 * Author URI:        https://example.com
 * License:           GPL-2.0-or-later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       wp-skeleton
 * Domain Path:       /languages
 * Requires at least: 6.0
 * Requires PHP:      8.2
 * Tested up to:      6.8
 */

declare(strict_types=1);

use WP\Skeleton\Adapter\WordpressPlugin;
use WP\Skeleton\Shared\Plugin\PluginContext;

// Prevent direct access
defined('ABSPATH') || exit;

// Check PHP version before loading anything
if (version_compare(PHP_VERSION, '8.2', '<')) {
    add_action('admin_notices', 'wp_skeleton_php_version_notice');
    return;
}

/**
 * Display PHP version requirement notice
 */
function wp_skeleton_php_version_notice(): void {
    ?>
    <div class="notice notice-error">
        <p>
            <?php
            printf(
                /* translators: 1: Current PHP version, 2: Required PHP version */
                esc_html__('WP Modern Plugin Skeleton requires PHP version %2$s or higher. You are running version %1$s. Please upgrade your PHP version.', 'wp-skeleton'),
                esc_html(PHP_VERSION),
                '8.2'
            );
            ?>
        </p>
    </div>
    <?php
}

// Autoloader
if (file_exists(__DIR__ . '/vendor/autoload.php')) {
    require_once __DIR__ . '/vendor/autoload.php';
} else {
    add_action('admin_notices', 'wp_skeleton_autoload_notice');
    return;
}

/**
 * Display autoloader missing notice
 */
function wp_skeleton_autoload_notice(): void {
    ?>
    <div class="notice notice-error">
        <p>
            <?php esc_html_e('WP Modern Plugin Skeleton: Composer dependencies not found. Please run `composer install`.', 'wp-skeleton'); ?>
        </p>
    </div>
    <?php
}

/**
 * Initialize the plugin
 */
function wp_skeleton_init(): void {
    try {
        // Create plugin context
        $plugin_context = new PluginContext(
            __FILE__,
            'wp-skeleton',
            'https://github.com/digi4care/wp-modern-plugin-skeleton',
            'wp-skeleton'
        );

        // Set plugin context and initialize
        WP\Skeleton\Infrastructure\DI\ContainerProvider::set_plugin_context($plugin_context);
        
        // Initialize main plugin
        WordpressPlugin::init(__FILE__);

    } catch (Throwable $e) {
        error_log('WP Modern Plugin Skeleton initialization failed: ' . $e->getMessage());
        wp_skeleton_display_error($e->getMessage());
    }
}

/**
 * Display error notice in admin
 */
function wp_skeleton_display_error(string $message): void {
    if (defined('WP_DEBUG') && WP_DEBUG && is_admin()) {
        add_action('admin_notices', function () use ($message) {
            ?>
            <div class="notice notice-error">
                <p>
                    <strong><?php esc_html_e('WP Modern Plugin Skeleton Error:', 'wp-skeleton'); ?></strong>
                    <?php echo esc_html($message); ?>
                </p>
            </div>
            <?php
        });
    }
}

// Initialize plugin
add_action('plugins_loaded', 'wp_skeleton_init');

/**
 * Example functionality - Greeting Shortcode
 * Usage: [skeleton_greet name="John"]
 */
function wp_skeleton_greeting_shortcode($atts): string {
    try {
        $atts = shortcode_atts([
            'name' => 'World',
            'class' => 'wp-skeleton-greeting'
        ], $atts, 'skeleton_greet');

        $container = WP\Skeleton\Infrastructure\DI\ContainerProvider::get_container();
        $greeting_app = $container->get(WP\Skeleton\Application\GreetingApplication::class);
        
        $greeting = $greeting_app->greet(sanitize_text_field($atts['name']));
        
        return sprintf(
            '<div class="%s">%s</div>',
            esc_attr($atts['class']),
            esc_html($greeting)
        );
    } catch (Exception $e) {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            return sprintf(
                '<div class="wp-skeleton-error">%s</div>',
                esc_html__('Error generating greeting.', 'wp-skeleton')
            );
        }
        return '';
    }
}
add_shortcode('skeleton_greet', 'wp_skeleton_greeting_shortcode');

/**
 * Example functionality - Add admin menu item
 */
function wp_skeleton_add_admin_menu(): void {
    add_menu_page(
        __('WP Skeleton', 'wp-skeleton'),
        __('WP Skeleton', 'wp-skeleton'),
        'manage_options',
        'wp-skeleton',
        'wp_skeleton_admin_page',
        'dashicons-admin-generic',
        20
    );
}
add_action('admin_menu', 'wp_skeleton_add_admin_menu');

/**
 * Admin page callback
 */
function wp_skeleton_admin_page(): void {
    ?>
    <div class="wrap">
        <h1><?php esc_html_e('WP Skeleton Plugin', 'wp-skeleton'); ?></h1>
        <div class="card">
            <h2><?php esc_html_e('Example Functionality', 'wp-skeleton'); ?></h2>
            <p><?php esc_html_e('This plugin demonstrates a modern WordPress plugin architecture.', 'wp-skeleton'); ?></p>
            
            <h3><?php esc_html_e('Available Shortcodes:', 'wp-skeleton'); ?></h3>
            <ul>
                <li><code>[skeleton_greet name="Your Name"]</code> - <?php esc_html_e('Displays a personalized greeting', 'wp-skeleton'); ?></li>
            </ul>
            
            <h3><?php esc_html_e('Example:', 'wp-skeleton'); ?></h3>
            <div class="example-output">
                <?php echo wp_skeleton_greeting_shortcode(['name' => 'WordPress User']); ?>
            </div>
        </div>
    </div>
    <?php
}