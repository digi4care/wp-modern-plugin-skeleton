<?php
/**
 * Plugin Name:       WP Modern Plugin Skeleton
 * Plugin URI:        https://github.com/digi4care/wp-modern-plugin-skeleton
 * Description:       Modern WordPress plugin skeleton using hexagonal architecture
 * Version:           0.1.0
 * Author:            Your Name <your.email@example.com> (https://example.com)
 * Author URI:        https://example.com
 * License:           GPL-2.0-or-later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       wp-modern-plugin-skeleton
 * Domain Path:       /languages
 * Requires at least: 6.0
 * Requires PHP:      8.2
 * Tested up to:      6.8
 * Stable tag:        0.1.0
 */

declare(strict_types=1);

use WP\Skeleton\Adapter\WordpressPlugin;
use WP\Skeleton\Shared\Plugin\PluginContext;
use WP\Skeleton\Infrastructure\DI\ContainerFactory;
use WP\Skeleton\Shared\Exception\PluginException;

// Prevent direct access
defined('ABSPATH') || exit;

// Check PHP version before loading anything
if (version_compare(PHP_VERSION, '8.2', '<')) {
    add_action('admin_notices', 'wp_skeleton_php_version_notice');
    return;
}

/**
 * Display PHP version requirement notice
 */
function wp_skeleton_php_version_notice(): void {
    ?>
    <div class="notice notice-error">
        <p>
            <?php
            printf(
                /* translators: 1: Current PHP version, 2: Required PHP version */
                esc_html__('WP Modern Plugin Skeleton requires PHP version %2$s or higher. You are running version %1$s. Please upgrade your PHP version.', 'wp-skeleton'),
                esc_html(PHP_VERSION),
                '8.2'
            );
            ?>
        </p>
    </div>
    <?php
}

// Autoloader
if (file_exists(__DIR__ . '/vendor/autoload.php')) {
    require_once __DIR__ . '/vendor/autoload.php';
} else {
    add_action('admin_notices', 'wp_skeleton_autoload_notice');
    return;
}

/**
 * Display autoloader missing notice
 */
function wp_skeleton_autoload_notice(): void {
    ?>
    <div class="notice notice-error">
        <p>
            <?php esc_html_e('WP Modern Plugin Skeleton: Composer dependencies not found. Please run `composer install`.', 'wp-skeleton'); ?>
        </p>
    </div>
    <?php
}

/**
 * Initialize the plugin
 */
function wp_skeleton_init(): void {
    try {
        // Create plugin context
        $plugin_context = new PluginContext(
            __FILE__,
            'wp-skeleton',
            'https://github.com/digi4care/wp-modern-plugin-skeleton',
            'wp-skeleton'
        );

        // Create container using factory (no singleton)
        $container_factory = new ContainerFactory();
        $container = $container_factory->create($plugin_context);
        
        // Initialize main plugin via dependency injection
        /** @var WordpressPlugin $plugin */
        $plugin = $container->get(WordpressPlugin::class);
        $plugin->init(__FILE__);

    } catch (PluginException $e) {
        error_log('WP Modern Plugin Skeleton initialization failed: ' . $e->getMessage());
        wp_skeleton_display_error($e->getMessage());
    } catch (Throwable $e) {
        error_log('WP Modern Plugin Skeleton unexpected error: ' . $e->getMessage());
        wp_skeleton_display_error(__('An unexpected error occurred during plugin initialization.', 'wp-skeleton'));
    }
}

/**
 * Display error notice in admin
 */
function wp_skeleton_display_error(string $message): void {
    if (defined('WP_DEBUG') && WP_DEBUG && is_admin()) {
        add_action('admin_notices', function () use ($message) {
            ?>
            <div class="notice notice-error">
                <p>
                    <strong><?php esc_html_e('WP Modern Plugin Skeleton Error:', 'wp-skeleton'); ?></strong>
                    <?php echo esc_html($message); ?>
                </p>
            </div>
            <?php
        });
    }
}

// Initialize plugin
add_action('plugins_loaded', 'wp_skeleton_init');

/**
 * Example functionality - Greeting Shortcode
 * Usage: [skeleton_greet name="John"]
 * 
 * @param array{name?: string, class?: string} $atts
 * @param WP\Skeleton\Application\GreetingApplication|null $greetingApp For testing purposes
 */
function wp_skeleton_greeting_shortcode(array $atts, ?WP\Skeleton\Application\GreetingApplication $greetingApp = null): string {
    try {
        $atts = shortcode_atts([
            'name' => 'World',
            'class' => 'wp-skeleton-greeting'
        ], $atts, 'skeleton_greet');

        // For testing, allow dependency injection
        if ($greetingApp === null) {
            // In production, create a new container instance
            $plugin_context = new PluginContext(
                __FILE__,
                'wp-skeleton',
                'https://github.com/digi4care/wp-modern-plugin-skeleton',
                'wp-skeleton'
            );
            $container_factory = new ContainerFactory();
            $container = $container_factory->create($plugin_context);
            $greetingApp = $container->get(WP\Skeleton\Application\GreetingApplication::class);
        }
        
        $greeting = $greetingApp->greet(sanitize_text_field($atts['name']));
        
        return sprintf(
            '<div class="%s">%s</div>',
            esc_attr($atts['class']),
            esc_html($greeting)
        );
    } catch (Exception $e) {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            return sprintf(
                '<div class="wp-skeleton-error">%s</div>',
                esc_html__('Error generating greeting.', 'wp-skeleton')
            );
        }
        return '';
    }
}
add_shortcode('skeleton_greet', 'wp_skeleton_greeting_shortcode');